name: Update Google Reviews Cache

on:
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  refresh-reviews:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Google reviews
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_PLACE_ID: ${{ secrets.GOOGLE_PLACE_ID }}
        run: |
          if [ -z "$GOOGLE_API_KEY" ] || [ -z "$GOOGLE_PLACE_ID" ]; then
            echo "Missing GOOGLE_API_KEY or GOOGLE_PLACE_ID" >&2
            exit 1
          fi

          mkdir -p src/assets/data
          curl -s "https://places.googleapis.com/v1/places/${GOOGLE_PLACE_ID}?fields=reviews&key=${GOOGLE_API_KEY}" \
            | jq '{
                reviews: (.reviews // []) | map({
                  author: (.authorAttribution.displayName // "Google user"),
                  text: ((.originalText.text // .text.text // "") | tostring),
                  rating: (.rating // 0),
                  date: (.relativePublishTimeDescription // .publishTime // "")
                })
              } | .reviews | map(select((.text != "") and (.author != ""))) | .[0:6]' \
            > src/assets/data/google-reviews.json

      - name: Commit changes
        run: |
          if git status --porcelain src/assets/data/google-reviews.json | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add src/assets/data/google-reviews.json
            git commit -m "chore: refresh google reviews cache"
            git push
          else
            echo "No review updates to commit"
          fi
